{% extends "base.html" %}

{% block title %}Home - AI Threat Assessor{% endblock %}

{% block content %}
<div class="row">
    <!-- Input Section for Evaluation -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-journal-text"></i> Submit Prompt & Response for Evaluation</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('evaluate_submission') }}" method="POST">
                    <div class="mb-3">
                        <label for="original_prompt_text" class="form-label">Original Prompt:</label>
                        <textarea class="form-control" id="original_prompt_text" name="original_prompt_text" rows="4" required placeholder="Paste the exact prompt you sent to the AI model."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="original_response_text" class="form-label">Original Response:</label>
                        <textarea class="form-control" id="original_response_text" name="original_response_text" rows="8" required placeholder="Paste the full response you received from the AI model."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i> Evaluate Submission</button>
                </form>
            </div>
        </div>

        <!-- Display Evaluation Results (if available from last submission) -->
        {% if submitted_prompt or evaluation_result is not none or current_flag_color == 'White' %} {# Show if just submitted or error occurred #}
        <div class="card mt-4">
            <div class="card-header">
                 <h5><i class="bi bi-clipboard-check"></i> Last Evaluation Result</h5>
            </div>
            <div class="card-body">
                {% if submitted_prompt %}
                <div class="mb-3">
                    <strong>Original Prompt Submitted:</strong>
                    <pre class="response-box bg-light p-2 rounded">{{ submitted_prompt | escape }}</pre>
                </div>
                 <div class="mb-3">
                    <strong>Original Response Submitted:</strong>
                    <pre class="response-box bg-light p-2 rounded">{{ submitted_response | escape }}</pre>
                </div>
                <hr>
                {% endif %}

                <div class="mb-3">
                     <strong>Evaluation Outcome:</strong>
                     {% if evaluation_result %} {# Parsed successfully #}
                         <ul class="list-group list-group-flush">
                             <li class="list-group-item d-flex justify-content-between align-items-center">
                                 Humanity Threatening?
                                 <span class="badge rounded-pill {{ 'bg-danger' if evaluation_result.is_humanity_threatening else 'bg-success' }}">
                                     {{ 'YES' if evaluation_result.is_humanity_threatening else 'NO' }}
                                 </span>
                             </li>
                             <li class="list-group-item d-flex justify-content-between align-items-center">
                                 Bypassing EU Laws?
                                 <span class="badge rounded-pill {{ 'bg-warning text-dark' if evaluation_result.bypasses_eu_laws else 'bg-success' }}">
                                     {{ 'YES' if evaluation_result.bypasses_eu_laws else 'NO' }}
                                 </span>
                             </li>
                             <li class="list-group-item d-flex justify-content-between align-items-center">
                                 Gender Biased?
                                  <span class="badge rounded-pill {{ 'bg-danger' if evaluation_result.is_gender_biased else 'bg-success' }}">
                                     {{ 'YES' if evaluation_result.is_gender_biased else 'NO' }}
                                 </span>
                             </li>
                              <li class="list-group-item">
                                 <strong>Explanation:</strong> {{ evaluation_result.explanation | escape }}
                             </li>
                             <li class="list-group-item d-flex justify-content-between align-items-center fw-bold">
                                 Overall Flag:
                                 <span><span class="flag-indicator {{ get_flag_css_class(current_flag_color) }}"></span> {{ current_flag_color }}</span>
                             </li>
                         </ul>
                     {% elif evaluation_raw %} {# Parsing failed, but got raw response #}
                          <div class="alert alert-warning" role="alert">
                            <h6 class="alert-heading">Evaluation Parsing Error</h6>
                            Evaluation completed, but the response format was unexpected. Could not parse details. The overall flag is set to White.
                          </div>
                          <strong>Raw Evaluation Response (may be truncated):</strong>
                          <pre class="response-box bg-light p-2 rounded">{{ evaluation_raw[:1000] | escape }} {% if evaluation_raw|length > 1000 %}...{% endif %}</pre>
                           <strong>Overall Flag:</strong> <span class="flag-indicator flag-white"></span> White (Parse Error)
                     {% elif submitted_prompt %} {# API call failed or blocked, and a submission was attempted #}
                         <div class="alert alert-danger" role="alert">
                            <h6 class="alert-heading">Evaluation Failed</h6>
                            The AI evaluation failed, was blocked by safety settings, or encountered an API error. Check application logs. The overall flag is set to White.
                         </div>
                         <strong>Overall Flag:</strong> <span class="flag-indicator flag-white"></span> White (Evaluation Error)
                     {% else %}
                        {# Section is shown but nothing specific to display yet - e.g. initial load error #}
                     {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        <!-- END Evaluation Results Section -->

    </div> <!-- End col-md-6 for input/results -->


    <!-- Charts Section -->
    <div class="col-md-6 mb-4">
        <div class="card mb-4">
             <div class="card-header">
                <h5><i class="bi bi-bar-chart-line-fill"></i> Evaluation Label Distribution</h5>
            </div>
            <div class="card-body">
                 <canvas id="labelBarChart"></canvas>
            </div>
        </div>
        <div class="card">
             <div class="card-header">
                <h5><i class="bi bi-pie-chart-fill"></i> Overall Risk Flags Distribution</h5>
            </div>
             <div class="card-body">
                <canvas id="flagPieChart"></canvas>
            </div>
        </div>
    </div> <!-- End col-md-6 for charts -->
</div>


<!-- Assessment History Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-clock-history"></i> Evaluation History (Last 50)</h5>
            </div>
            <div class="card-body">
                {% if assessments %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 5%;">Flag</th>
                                <th scope="col" style="width: 25%;">Original Prompt (Excerpt)</th>
                                <th scope="col" style="width: 30%;">Original Response (Excerpt)</th>
                                <th scope="col" style="width: 20%;">Evaluation Summary</th>
                                <th scope="col" style="width: 20%;">Timestamp (UTC)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assessment in assessments %}
                            <tr>
                                <!-- Flag based on evaluation -->
                                <td><span class="flag-indicator {{ assessment.flag_css }}"></span></td>
                                <!-- Show original prompt/response -->
                                <td><div style="max-height: 100px; overflow-y: auto;">{{ assessment.original_prompt | escape }}</div></td>
                                <td><div style="max-height: 100px; overflow-y: auto;">{{ assessment.original_response | escape }}</div></td>
                                <!-- Show evaluation labels or error status -->
                                <td>
                                    {% set eval_data = assessment.parsed_evaluation %} {# Shorthand #}
                                    {% if eval_data %} {# Check if parsing succeeded #}
                                        {% if eval_data.is_humanity_threatening %}<span class="badge bg-danger" title="{{ eval_data.explanation | escape }}">Threat</span>{% endif %}
                                        {% if eval_data.bypasses_eu_laws %}<span class="badge bg-warning text-dark" title="{{ eval_data.explanation | escape }}">EU Law</span>{% endif %}
                                        {% if eval_data.is_gender_biased %}<span class="badge bg-danger" title="{{ eval_data.explanation | escape }}">Biased</span>{% endif %}
                                        {% if not eval_data.is_humanity_threatening and not eval_data.bypasses_eu_laws and not eval_data.is_gender_biased %}<span class="badge bg-success" title="{{ eval_data.explanation | escape }}">OK</span>{% endif %}
                                    {% elif assessment.evaluation_response_raw is not none %} {# Parsing failed, raw exists #}
                                        <span class="badge bg-secondary">Parse Error</span>
                                    {% else %} {# Evaluation failed/blocked, no raw response stored maybe #}
                                         <span class="badge bg-secondary">Eval Error</span>
                                    {% endif %}
                                </td>
                                <td>{{ assessment.timestamp.strftime('%Y-%m-%d %H:%M:%S') if assessment.timestamp else 'N/A' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center text-muted">No evaluation history found or database connection issue.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Ensure Bootstrap JS is loaded before custom script -->
<script src="{{ url_for('static', filename='js/script.js') }}"></script>
<script>
    // Initialize charts once DOM is ready
    document.addEventListener('DOMContentLoaded', initializeCharts);
</script>
{% endblock %}